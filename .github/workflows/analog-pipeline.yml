name: "üß† Analog-AI ‚Äî Meaning Curve Engine (v4.1)"

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: analog-ai-${{ github.ref }}
  cancel-in-progress: false

jobs:
  analog-meaning-build:
    name: "üß† Build & Run Meaning Curve Engine"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # ---------------------------------------
      # Checkout + Build Environment
      # ---------------------------------------
      - name: "üì¶ Checkout"
        uses: actions/checkout@v4

      - name: "ü¶Ä Setup Rust"
        uses: dtolnay/rust-toolchain@stable

      - name: "üìö Install NASM (Linux/Mac)"
        if: runner.os != 'Windows'
        run: |
          sudo apt-get update || true
          sudo apt-get install -y nasm || true

      - name: "üìö Install NASM (Windows)"
        if: runner.os == 'Windows'
        run: |
          choco install nasm -y

      # ---------------------------------------
      # Build Meaning Engine
      # ---------------------------------------
      - name: "‚öôÔ∏è Build Meaning Engine"
        run: cargo build --release

      - name: "üß™ SpongeLang Semantic Tests"
        run: cargo test --all --verbose

      # ---------------------------------------
      # Meaning Curve Generation
      # ---------------------------------------
      - name: "üß† Run Meaning Curve Engine"
        shell: bash
        run: |
          mkdir -p analog-output
          echo "Running meaning curve engine..."

          if [ ! -f "samples/sample.sp" ]; then
            echo "‚ùå ERROR: samples/sample.sp not found in repository."
            exit 1
          fi

          ./target/release/analog-ai-meaning-engine "samples/sample.sp" > analog-output/curve.txt

      # ---------------------------------------
      # SHA256 + ProofLedger
      # ---------------------------------------
      - name: "üîê Generate SHA256 Proof"
        shell: bash
        run: |
          sha256sum analog-output/curve.txt > analog-output/sha256.txt || \
          shasum -a 256 analog-output/curve.txt > analog-output/sha256.txt

      - name: "üìú Create ProofLedger"
        shell: bash
        run: |
          mkdir -p proof
          {
            echo "Analog-AI ProofLedger"
            echo "timestamp=$(date -u)"
            echo "commit=${GITHUB_SHA}"
            echo "os=${RUNNER_OS}"
            echo "source_file=samples/sample.sp"
            echo "curve=analog-output/curve.txt"
            echo "sha256=$(cat analog-output/sha256.txt)"
          } > proof/ledger.txt

      # ---------------------------------------
      # Upload artifacts so release job can download
      # ---------------------------------------
      - name: "üì¶ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: analog-ai-${{ matrix.os }}
          path: |
            samples/sample.sp
            analog-output/
            proof/

  # =====================================================================
  # RELEASE JOB (Auto Tag + Release)
  # =====================================================================
  create-release:
    name: "üöÄ Auto Tag & Release"
    runs-on: ubuntu-latest
    needs: analog-meaning-build
    permissions:
      contents: write

    steps:
      - name: "üì¶ Checkout"
        uses: actions/checkout@v4

      # -----------------------------
      # VERSION GENERATION
      # -----------------------------
      - name: "üî¢ Generate Version (timestamp)"
        id: version
        run: |
          VERSION="v$(date +'%Y%m%d-%H%M%S')"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # -----------------------------
      # TAG CREATION
      # -----------------------------
      - name: "üè∑Ô∏è Create Tag"
        run: |
          git tag ${{ steps.version.outputs.version }}
          git push origin ${{ steps.version.outputs.version }}

      # -----------------------------
      # RELEASE CREATION
      # -----------------------------
      - name: "üöÄ Create GitHub Release"
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # FIXES 422
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Analog-AI Release ‚Äî ${{ steps.version.outputs.version }}"
          body: |
            üß† **Analog-AI Meaning Curve Engine Auto Release**

            - Version: ${{ steps.version.outputs.version }}
            - Generated automatically via GitHub Actions
            - Includes multi-OS artifacts, meaning curve, SHA256, and ProofLedger.

      # -----------------------------
      # UPLOAD ARTIFACTS TO RELEASE
      # -----------------------------
      - name: "üì• Download All Artifacts"
        uses: actions/download-artifact@v4

      - name: "üì§ Upload Artifacts to Release"
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # FIXES 422
        with:
          tag_name: ${{ steps.version.outputs.version }}
          files: |
            analog-ai-ubuntu-latest/**
            analog-ai-macos-latest/**
            analog-ai-windows-latest/**
