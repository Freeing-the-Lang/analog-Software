name: "ğŸ§  Analog-AI â€” SpongeLang â†’ Meaning Curve Engine (v3.0)"

on:
  push:
    branches: [ main ]
    tags:
      - "v*"
  pull_request:
    types: [ closed ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: analog-ai-${{ github.ref }}
  cancel-in-progress: false

jobs:
  analog-meaning-build:
    name: "ğŸ§  Build & Run Meaning Curve Engine"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # ----- ê¸°ë³¸ -----
      - name: "ğŸ“¦ Checkout"
        uses: actions/checkout@v4

      - name: "ğŸ¦€ Setup Rust"
        uses: dtolnay/rust-toolchain@stable

      - name: "ğŸ“š Install NASM (Linux/Mac)"
        if: runner.os != 'Windows'
        run: |
          sudo apt-get update || true
          sudo apt-get install -y nasm || true

      - name: "ğŸ“š Install NASM (Windows)"
        if: runner.os == 'Windows'
        run: |
          choco install nasm -y

      # ----- ì»´íŒŒì¼ -----
      - name: "âš™ï¸ Build Meaning Engine"
        run: cargo build --release

      # ----- í…ŒìŠ¤íŠ¸ -----
      - name: "ğŸ§ª SpongeLang Semantic Tests"
        run: cargo test --all --verbose

      # ----- â˜… example.spë¥¼ 'ë‹¤ë¥¸ ë””ë ‰í† ë¦¬(examples/)'ì— ìƒì„± -----
      - name: "ğŸ“„ Generate example.sp"
        shell: bash
        run: |
          echo "Creating examples/example.sp..."
          mkdir -p examples
          cat << 'EOF' > examples/example.sp
# Digital â†’ Analog Thinking Demo
# SpongeLang Example File (example.sp)

# 1) ë””ì§€í„¸ì‹ ë¶„ê¸° â†’ ì•„ë‚ ë¡œê·¸ í•´ì„
if user_score > 80 -> pass
else -> retry

# 2) ì•„ë‚ ë¡œê·¸ ë§¤í•‘
emotion_level = map(feeling, 0..1 -> calm..focus)

# 3) ì˜ë¯¸ ê¸°ë°˜ í•¨ìˆ˜ ì¡°í•©
fn blend(a, b) = (a * 0.6) + (b * 0.4)

# 4) ì—°ì† ì˜ë¯¸ íë¦„ (analog reasoning)
temperature = smooth(prev_temp -> next_temp)

# 5) ë””ì§€í„¸â†’ì•„ë‚ ë¡œê·¸ ì‚¬ê³  ì‹¤í—˜
concept = "digital-to-analog"
EOF

      # ----- ì˜ë¯¸ê³¡ì„  ì—”ì§„ ì‹¤í–‰ -----
      - name: "ğŸ§  Run Meaning Curve Engine"
        shell: bash
        run: |
          mkdir -p analog-output
          echo "Running meaning curve engine..."
          ./target/release/analog-ai-meaning-engine "examples/example.sp" > analog-output/curve.txt

      # ----- SHA256 ì¸ì¦ -----
      - name: "ğŸ” Generate SHA256 Proof"
        shell: bash
        run: |
          sha256sum analog-output/curve.txt > analog-output/sha256.txt || \
          shasum -a 256 analog-output/curve.txt > analog-output/sha256.txt

      # ----- ProofLedger -----
      - name: "ğŸ“œ Create ProofLedger"
        shell: bash
        run: |
          mkdir -p proof
          {
            echo "Analog-AI ProofLedger"
            echo "timestamp=$(date -u)"
            echo "commit=${GITHUB_SHA}"
            echo "os=${RUNNER_OS}"
            echo "source_file=examples/example.sp"
            echo "curve=analog-output/curve.txt"
            echo "sha256=$(cat analog-output/sha256.txt)"
          } > proof/ledger.txt

      # ----- ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ -----
      - name: "ğŸ“¦ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: analog-ai-${{ matrix.os }}
          path: |
            examples/
            analog-output/
            proof/
