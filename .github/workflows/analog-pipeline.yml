name: "üß† Analog-AI ‚Äî Meaning Curve Engine (v4.2)"

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: analog-ai-${{ github.ref }}
  cancel-in-progress: false

# ============================================================
# BUILD JOB ‚Äî 3OS Meaning Engine
# ============================================================
jobs:
  analog-meaning-build:
    name: "üß† Build & Run Meaning Curve Engine"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # ---------------------------------------
      # Checkout
      # ---------------------------------------
      - name: "üì¶ Checkout"
        uses: actions/checkout@v4

      - name: "ü¶Ä Setup Rust"
        uses: dtolnay/rust-toolchain@stable

      # ---------------------------------------
      # Install NASM (Platform Specific)
      # ---------------------------------------
      - name: "üìö Install NASM (Linux)"
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm

      - name: "üìö Install NASM (macOS)"
        if: runner.os == 'macOS'
        run: |
          brew install nasm

      - name: "üìö Install NASM (Windows)"
        if: runner.os == 'Windows'
        run: |
          choco install nasm -y

      # ---------------------------------------
      # Build Engine
      # ---------------------------------------
      - name: "‚öôÔ∏è Build Meaning Engine"
        run: cargo build --release

      - name: "üß™ SpongeLang Semantic Tests"
        run: cargo test --all --verbose

      # ---------------------------------------
      # Meaning Curve Generation ‚Äî FIXED
      # ---------------------------------------
      - name: "üß† Run Meaning Curve Engine (Linux/macOS)"
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p analog-output
          ./target/release/analog-ai-meaning-engine "samples/sample.sp" > analog-output/curve.txt

      - name: "üß† Run Meaning Curve Engine (Windows)"
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          mkdir analog-output
          .\target\release\analog-ai-meaning-engine.exe "samples/sample.sp" | Out-File -Encoding utf8 analog-output/curve.txt

      # ---------------------------------------
      # SHA256 + ProofLedger
      # ---------------------------------------
      - name: "üîê SHA256 Proof"
        shell: bash
        run: |
          sha256sum analog-output/curve.txt > analog-output/sha256.txt 2>/dev/null || \
          shasum -a 256 analog-output/curve.txt > analog-output/sha256.txt

      - name: "üìú Generate ProofLedger"
        shell: bash
        run: |
          mkdir -p proof
          {
            echo "Analog-AI ProofLedger"
            echo "timestamp=$(date -u)"
            echo "commit=${GITHUB_SHA}"
            echo "os=${RUNNER_OS}"
            echo "source=samples/sample.sp"
            echo "curve=analog-output/curve.txt"
            echo "sha256=$(cat analog-output/sha256.txt)"
          } > proof/ledger.txt

      # ---------------------------------------
      # Upload artifacts
      # ---------------------------------------
      - name: "üì¶ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: analog-ai-${{ matrix.os }}
          path: |
            samples/sample.sp
            analog-output/
            proof/

# ============================================================
# RELEASE JOB (Auto Tag + Release)
# ============================================================
  create-release:
    name: "üöÄ Auto Tag & Release"
    runs-on: ubuntu-latest
    needs: analog-meaning-build

    permissions:
      contents: write

    steps:
      - name: "üì¶ Checkout"
        uses: actions/checkout@v4

      # -----------------------------
      # Version
      # -----------------------------
      - name: "üî¢ Generate Version"
        id: version
        run: |
          VERSION="v$(date +'%Y%m%d-%H%M%S')"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: "üè∑Ô∏è Create Tag"
        run: |
          git tag ${{ steps.version.outputs.version }}
          git push origin ${{ steps.version.outputs.version }}

      # -----------------------------
      # Create Release
      # -----------------------------
      - name: "üöÄ Create Release"
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Analog-AI ‚Äî ${{ steps.version.outputs.version }}"
          body: |
            üß† **Analog-AI Meaning Curve Engine Auto Release**
            - Version: ${{ steps.version.outputs.version }}
            - Multi-OS build (Linux, macOS, Windows)
            - SHA256 Proof + ProofLedger included

      # -----------------------------
      # Upload All Artifacts
      # -----------------------------
      - name: "üì• Download All Artifacts"
        uses: actions/download-artifact@v4

      - name: "üì§ Upload to Release"
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          files: |
            analog-ai-ubuntu-latest/**
            analog-ai-macos-latest/**
            analog-ai-windows-latest/**

