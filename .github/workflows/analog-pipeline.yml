name: "ğŸ§  Analog-AI â€” Meaning Curve Engine (v4.0)"

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: analog-ai-${{ github.ref }}
  cancel-in-progress: false

jobs:
  analog-meaning-build:
    name: "ğŸ§  Build & Run Meaning Curve Engine"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: "ğŸ“¦ Checkout"
        uses: actions/checkout@v4

      - name: "ğŸ¦€ Setup Rust"
        uses: dtolnay/rust-toolchain@stable

      - name: "ğŸ“š Install NASM (Linux/Mac)"
        if: runner.os != 'Windows'
        run: |
          sudo apt-get update || true
          sudo apt-get install -y nasm || true

      - name: "ğŸ“š Install NASM (Windows)"
        if: runner.os == 'Windows'
        run: |
          choco install nasm -y

      - name: "âš™ï¸ Build Meaning Engine"
        run: cargo build --release

      - name: "ğŸ§ª SpongeLang Semantic Tests"
        run: cargo test --all --verbose

      # ----- sample.sp MUST exist -----
      - name: "ğŸ§  Run Meaning Curve Engine"
        shell: bash
        run: |
          mkdir -p analog-output
          echo "Running meaning curve engine..."
          
          if [ ! -f "samples/sample.sp" ]; then
            echo "âŒ ERROR: samples/sample.sp not found in repository."
            exit 1
          fi

          ./target/release/analog-ai-meaning-engine "samples/sample.sp" > analog-output/curve.txt

      - name: "ğŸ” Generate SHA256 Proof"
        shell: bash
        run: |
          sha256sum analog-output/curve.txt > analog-output/sha256.txt || \
          shasum -a 256 analog-output/curve.txt > analog-output/sha256.txt

      - name: "ğŸ“œ Create ProofLedger"
        shell: bash
        run: |
          mkdir -p proof
          {
            echo "Analog-AI ProofLedger"
            echo "timestamp=$(date -u)"
            echo "commit=${GITHUB_SHA}"
            echo "os=${RUNNER_OS}"
            echo "source_file=samples/sample.sp"
            echo "curve=analog-output/curve.txt"
            echo "sha256=$(cat analog-output/sha256.txt)"
          } > proof/ledger.txt

      # Save artifacts for release job
      - name: "ğŸ“¦ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: analog-ai-${{ matrix.os }}
          path: |
            samples/sample.sp
            analog-output/
            proof/

  # -----------------------------
  #   ğŸš€ Release Tag + GitHub Release
  # -----------------------------
  create-release:
    name: "ğŸš€ Auto Tag & Release"
    runs-on: ubuntu-latest
    needs: analog-meaning-build
    permissions:
      contents: write

    steps:
      - name: "ğŸ“¦ Checkout"
        uses: actions/checkout@v4

      # ----- ìë™ ë²„ì „ ìƒì„± -----
      - name: "ğŸ”¢ Generate Version (timestamp)"
        id: version
        run: |
          VERSION="v$(date +'%Y%m%d-%H%M%S')"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # ----- íƒœê·¸ ìƒì„± -----
      - name: "ğŸ·ï¸ Create Tag"
        run: |
          git tag ${{ steps.version.outputs.version }}
          git push origin ${{ steps.version.outputs.version }}

      # ----- Release ìƒì„± -----
      - name: "ğŸš€ Create GitHub Release"
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Analog-AI Release â€” ${{ steps.version.outputs.version }}"
          body: |
            ğŸ§  **Analog-AI Meaning Curve Engine Auto Release**

            - Tag: ${{ steps.version.outputs.version }}
            - Timestamp: $(date -u)
            - Auto-generated by GitHub Actions

      # ----- OSë³„ ì•„í‹°íŒ©íŠ¸ Releaseì— ì—…ë¡œë“œ -----
      - name: "ğŸ“¦ Download all artifacts"
        uses: actions/download-artifact@v4

      - name: "ğŸ“¤ Upload Artifacts to Release"
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          files: |
            analog-ai-ubuntu-latest/**
            analog-ai-macos-latest/**
            analog-ai-windows-latest/**
