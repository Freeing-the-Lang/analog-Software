name: "ðŸ§  Analog-AI â€” Meaning Curve Engine (v3.2)"

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: analog-ai-${{ github.ref }}
  cancel-in-progress: false

jobs:
  analog-meaning-build:
    name: "ðŸ§  Build & Run Meaning Curve Engine"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: "ðŸ“¦ Checkout"
        uses: actions/checkout@v4

      - name: "ðŸ¦€ Setup Rust"
        uses: dtolnay/rust-toolchain@stable

      - name: "ðŸ“š Install NASM (Linux/Mac)"
        if: runner.os != 'Windows'
        run: |
          sudo apt-get update || true
          sudo apt-get install -y nasm || true

      - name: "ðŸ“š Install NASM (Windows)"
        if: runner.os == 'Windows'
        run: |
          choco install nasm -y

      - name: "âš™ï¸ Build Meaning Engine"
        run: cargo build --release

      - name: "ðŸ§ª SpongeLang Semantic Tests"
        run: cargo test --all --verbose

      # ----- sample.sp ìž„ë² ë”© ì—†ì´ repo ë‚´ë¶€ íŒŒì¼ë§Œ ì‚¬ìš© -----
      - name: "ðŸ§  Run Meaning Curve Engine"
        shell: bash
        run: |
          mkdir -p analog-output
          echo "Running meaning curve engine..."
          
          # sample.sp MUST exist in repo
          if [ ! -f "samples/sample.sp" ]; then
            echo "âŒ ERROR: samples/sample.sp not found in repository."
            exit 1
          fi

          ./target/release/analog-ai-meaning-engine "samples/sample.sp" > analog-output/curve.txt

      - name: "ðŸ” Generate SHA256 Proof"
        shell: bash
        run: |
          sha256sum analog-output/curve.txt > analog-output/sha256.txt || \
          shasum -a 256 analog-output/curve.txt > analog-output/sha256.txt

      - name: "ðŸ“œ Create ProofLedger"
        shell: bash
        run: |
          mkdir -p proof
          {
            echo "Analog-AI ProofLedger"
            echo "timestamp=$(date -u)"
            echo "commit=${GITHUB_SHA}"
            echo "os=${RUNNER_OS}"
            echo "source_file=samples/sample.sp"
            echo "curve=analog-output/curve.txt"
            echo "sha256=$(cat analog-output/sha256.txt)"
          } > proof/ledger.txt

      - name: "ðŸ“¦ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: analog-ai-${{ matrix.os }}
          path: |
            samples/sample.sp
            analog-output/
            proof/
